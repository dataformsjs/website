!function(){"use strict";var s={cm:null,lang:navigator.language,urlRoot:"https://playground.dataformsjs.com/",selectedFile:null,fileList:[],fileCache:{},siteKey:null,siteString:null,siteExpires:null,contentChanged:!1,countdownInterval:null};function e(){s.lang=window.i18n_Locale,s.siteKey=localStorage.getItem("playground_site"),f(),s.siteKey?0===s.fileList.length||null===s.selectedFile?t("download-site"):(h(),E(s.fileCache[s.selectedFile]),d()):t("site-template"),function(){var e=document.querySelectorAll(".btn.create-site");if(0===e.length)return;e[0].onclick=l,e[1].onclick=l,document.querySelector(".btn.save-file").onclick=x,document.querySelector(".btn.rename-file").onclick=b,document.querySelector(".btn.add-file").onclick=g,document.querySelector(".btn.delete-file").onclick=q,document.querySelector(".btn.delete-site").onclick=A,document.getElementById("file-list").onchange=function(){S(this.value)},document.querySelector(".error .close-error").onclick=function(){document.querySelector(".content.error-message").style.display="none"},n();var t=document.getElementById("file-type");t.onchange=function(){s.cm.toTextArea(),s.cm=null,w(t.options[t.selectedIndex].getAttribute("data-mode")),i()};e=document.getElementById("file-name");e.oninput=i,e.onpaste=function(e){var t=e.clipboardData.getData("text/plain");/^[A-Za-z0-9_-]{1,}$/.test(t)||e.preventDefault()},e.onkeydown=function(e){var t=e.keyCode;switch(e.keyCode){case 8:case 37:case 38:case 39:case 40:case 46:case 189:return}if(!(65<=t&&t<=90)&&!(97<=t&&t<=122)&&(!(48<=t&&t<=57)||e.shiftKey))return!1}}(),document.onkeydown=function(e){if(s.siteKey&&(e.ctrlKey||e.metaKey)&&83===e.keyCode)return x(),!1}}function o(){null!==s.countdownInterval&&(window.clearInterval(s.countdownInterval),s.countdownInterval=null),s.selectedFile=null,s.fileList=[],s.fileCache={},s.siteKey=null,s.siteString=null,s.siteExpires=null,s.contentChanged=!1,localStorage.removeItem("playground_site"),s.cm.toTextArea(),s.cm=null,document.getElementById("code-editor").value="",document.getElementById("countdown").className="",document.querySelector(".editor-container").classList.remove("warning"),t("site-template"),function(){document.querySelector(".create-site-overlay").style.display="",document.querySelector(".create-another-site-screen").style.display="";var e=document.querySelectorAll(".controls");Array.prototype.forEach.call(e,function(e){e.style.display="none"}),document.querySelector(".editor-container").classList.add("no-site"),document.querySelector(".btn.view-site").href="#",document.querySelector(".btn.view-file").href="#"}()}function a(e,t){return fetch(e,t).then(function(e){return e.json()}).then(function(e){if(e.error)throw e.error;return e})}function t(n){var e={method:"POST",cache:"no-store",mode:"cors",credentials:"include"};"download-site"===n?e.headers={Authorization:"Bearer "+s.siteKey}:n=s.lang+"/"+n,a(s.urlRoot+n,e).then(function(e){e=e,s.fileList=e.files,h(),document.getElementById("code-editor").value=e.app_code,s.fileCache["app.htm"]={type:"htm",file:"app.htm",content:e.app_code},w(),v("app.htm"),s.siteKey&&d()}).catch(function(e){if("download-site"!==n){var t=document.querySelector(".error-messages");if(!t)return;t=t.getAttribute("data-server-down");c(t+=" Error: "+e.toString())}else c(e);"download-site"===n&&window.setTimeout(function(){var e=document.querySelector(".error-messages");e&&(e=e.getAttribute("data-saved-site"),confirm(e)&&(localStorage.removeItem("playground_site"),s.siteKey=null,s.siteString=null,s.siteExpires=null,window.location.reload(!0)))},100)})}function n(){var e,t=document.querySelector(".mobile-message p");t&&(e=-1<(e=window.navigator.userAgent.toLowerCase()).indexOf("android")||-1<e.indexOf("iphone")||-1<e.indexOf("ipad")?"data-mobile-screen":"data-narrow-screen",t.textContent=t.getAttribute(e))}function c(e){var t,n,l=document.querySelector(".error-message");l&&(t=l.querySelector("p .text"),-1===(n=e).toString().toLowerCase().indexOf("error")&&(n="Error: "+n),t.textContent=n,l.style.display="",console.error(e))}function r(){document.querySelector(".btn.save-file").style.display="none",document.querySelector(".btn.rename-file").style.display="none",document.querySelector(".msg.file-already-exists").style.display="none"}function i(){var e,t=document.querySelector(".btn.save-file"),n=document.querySelector(".btn.rename-file"),l=document.querySelector(".msg.file-already-exists"),o=document.getElementById("file-name").value,r=""!==o,i=null===s.selectedFile,a=s.selectedFile;i||(a=a.substring(0,a.indexOf(".")));var c="app.htm"!==s.selectedFile&&!i&&a!==o,d=!1,a=!1;(i||c)&&("app.htm"===(i=o+"."+(i?document.getElementById("file-type").value:s.fileCache[s.selectedFile].type)).toLowerCase()||"index.htm"===i.toLowerCase()?a=!0:d=u(i)),l.style.display="none",r?d||a?(e=d?"data-already-exists":"data-name-not-allowed",l.textContent=l.getAttribute(e),l.style.display="",t.style.display="none",n.style.display="none"):c?(p()||(t.querySelector(".text").textContent=t.getAttribute("data-save-as"),t.style.display=""),e=s.contentChanged?"data-rename-and-save":"data-rename",n.querySelector(".text").textContent=n.getAttribute(e),n.style.display=""):(s.contentChanged?(t.querySelector(".text").textContent=t.getAttribute("data-save"),t.style.display=""):t.style.display="none",n.style.display="none"):(t.style.display="none",n.style.display="none")}function u(e){e=e.toLowerCase();for(var t=0,n=s.fileList.length;t<n;t++)if(s.fileList[t].toLowerCase()===e)return!0;return"index.htm"===e}function l(){a(s.urlRoot+s.lang+"/create-site",{method:"POST",cache:"no-store"}).then(function(e){e=e.site,s.siteKey=e,localStorage.setItem("playground_site",e),f(),d()}).catch(function(e){c(e)})}function d(){document.querySelector(".create-site-overlay").style.display="none",document.querySelector(".create-site-screen").style.display="none",document.querySelector(".create-another-site-screen").style.display="none";var e=document.querySelectorAll(".controls");Array.prototype.forEach.call(e,function(e){e.style.display=""}),document.querySelector(".editor-container").classList.remove("no-site");e=s.urlRoot+"sites/"+s.siteString+"/app.htm";document.querySelector(".btn.view-site").href=e,document.querySelector(".btn.view-file").href=e,y()}function y(){var e,t=new Date,n=Math.floor((s.siteExpires-t.getTime())/1e3),l=document.getElementById("countdown"),t=0;null!==s.countdownInterval&&(window.clearInterval(s.countdownInterval),s.countdownInterval=null),60<n?(e=Math.ceil(n/60),0===(t=n%60)&&(t=60),l.textContent=l.getAttribute("data-minutes").replace("{time}",e),s.countdownInterval=window.setTimeout(y,1e3*t)):(m(l,n),n--,s.countdownInterval=window.setInterval(function(){m(l,n),--n<0&&(document.querySelector(".site-expired").style.display="",o())},1e3)),n<=600&&l.classList.add("warning")}function m(e,t){e.textContent=1===t?e.getAttribute("data-one-second"):e.getAttribute("data-seconds").replace("{time}",t),e.classList.toggle("scale"),document.querySelector(".editor-container").classList.toggle("warning")}function f(){var e;s.siteKey&&((e=s.siteKey.match(/^([a-zA-Z0-9_-]{2,}).s.(\d+).[a-zA-Z0-9_-]{2,}$/))?(s.siteString=function(e){var t=e.length%4;0!==t&&(t=4-t);t=e.replace(/_/g,"/").replace(/-/g,"+")+"=".repeat(t);return atob(t)}(e[1]),s.siteExpires=parseInt(e[2],10),Date.now()>new Date(s.siteExpires)&&(s.siteKey=null,s.siteString=null,s.siteExpires=null)):s.siteKey=null)}function p(){return 30<=s.fileList.length}function h(){s.fileList.sort(function(e,t){return"app.htm"===e?-1:"app.htm"===t?1:e.localeCompare(t)});for(var e="",t="",n=0,l=s.fileList.length;n<l;n++){var o=s.fileList[n],r=o.indexOf(".");e+='<li class="'+o.substring(r+1)+'">'+(o=null!=(r=o)&&"number"!=typeof r?String(r).replace(/&/g,"&amp;").replace(/"/g,"&quot;").replace(/'/g,"&#039;").replace(/</g,"&lt;").replace(/>/g,"&gt;"):r)+"</li>",t+="<option>"+o+"</option>"}document.querySelector(".files ul").innerHTML=e,document.getElementById("file-list").innerHTML=t;var i=document.querySelector(".btn.add-file"),a=document.querySelector(".msg.file-limit");p()?(a.style.display="",i.style.display="none"):(a.style.display="none",i.style.display="");i=document.querySelectorAll(".files li");Array.prototype.forEach.call(i,function(e){e.onclick=function(){S(this.textContent)}})}function g(){var e=document.querySelectorAll(".files li");Array.prototype.forEach.call(e,function(e){e.classList.remove("active")}),s.selectedFile=null,s.contentChanged=!0;var t=document.getElementById("file-type");document.getElementById("file-name").value="",document.getElementById("file-name").disabled=!1,t.style.display="",document.querySelector(".btn.view-file").style.display="none",document.querySelector(".btn.delete-file").style.display="none",r();e=document.getElementById("file-name");e.value="",e.style.display="",s.cm.toTextArea(),s.cm=null,document.getElementById("code-editor").value="",w(t.options[t.selectedIndex].getAttribute("data-mode"))}function v(n){var e=document.querySelectorAll(".files li");Array.prototype.forEach.call(e,function(e){e.textContent===n?e.classList.add("active"):e.classList.remove("active")}),s.selectedFile=n,s.contentChanged=!1;var t=document.querySelector(".btn.view-file");t.style.display="none",s.siteString&&"app.htm"!==n&&(t.href=s.urlRoot+"sites/"+s.siteString+"/",t.href+=n,t.style.display="");var l=document.getElementById("file-name"),e=document.querySelector(".btn.delete-file");"app.htm"===n?(l.disabled=!0,l.value=n,e.style.display="none"):(t=n.indexOf("."),t=n.substring(0,t),l.disabled=!1,l.value=t,l.style.display="",e.style.display=""),document.getElementById("file-type").style.display="none",r(),s.cm.on("change",function(){s.cm.save();var e=void 0===s.fileCache[n]?"":s.fileCache[n].content,t=document.getElementById("code-editor").value,e=e.replace(/\r\n/g,"\n"),t=t.replace(/\r\n/g,"\n");s.contentChanged=t!==e,i()})}function w(e){void 0===e&&(e="text/x-handlebars-template");var t={lineNumbers:!0,matchBrackets:!0,mode:e,indentUnit:4,indentWithTabs:!1};"text/javascript"===e?(t.gutters=["CodeMirror-lint-markers"],t.lint=!0):"text/x-handlebars-template"===e&&(t.mode={name:"handlebars",base:"htmlmixed"}),null===s.cm||(e=document.querySelectorAll(".CodeMirror.cm-s-default"))&&Array.prototype.forEach.call(e,function(e){e.parentNode.removeChild(e)}),s.cm=CodeMirror.fromTextArea(document.getElementById("code-editor"),t)}function S(e){var t;void 0!==s.fileCache[e]?E(s.fileCache[e]):(t=e,a(s.urlRoot+"get-file",{method:"POST",cache:"no-store",mode:"cors",credentials:"include",headers:{Authorization:"Bearer "+s.siteKey,"X-File":t}}).then(function(e){E(s.fileCache[t]=e)}).catch(function(e){c(e)}))}function x(){s.cm.save();var e,t=document.getElementById("code-editor").value,n=null,l=null,o=document.getElementById("file-name").value,r=!1,i=!1;if(null===s.selectedFile){if(l=o,n=document.getElementById("file-type").value,r=!0,""===l||""===n)return;l+="."+n}else l="app.htm"===s.selectedFile?s.selectedFile:(e=(e=s.selectedFile).substring(0,e.indexOf(".")),(i=e!==o)?o+"."+(n=s.fileCache[s.selectedFile].type):s.selectedFile);(r||i)&&u(l)||i&&p()||a(s.urlRoot+"save-file",{method:"POST",cache:"no-store",mode:"cors",credentials:"include",headers:{Authorization:"Bearer "+s.siteKey,"X-File":l,"Content-Type":"text/plain"},body:t}).then(function(){r||i?(s.fileCache[l]={type:n,file:l,content:t},s.fileList.push(l),h(),v(l)):(s.fileCache[l].content=t,s.contentChanged=!1),C()}).catch(function(e){c(e)})}function b(){s.cm.save();var e=document.getElementById("code-editor").value,t=s.selectedFile,n=s.fileCache[t].type,l=document.getElementById("file-name").value+"."+n;a(s.urlRoot+"rename-file",{method:"POST",cache:"no-store",mode:"cors",credentials:"include",headers:{Authorization:"Bearer "+s.siteKey,"X-File":t,"X-Rename":l,"Content-Type":"text/plain"},body:e}).then(function(){delete s.fileCache[t],s.fileList.splice(s.fileList.indexOf(t),1),s.fileCache[l]={type:n,file:l,content:e},s.fileList.push(l),h(),v(l),C()}).catch(function(e){c(e)})}function q(){var e=s.urlRoot+"delete-file",t=s.selectedFile;a(e,{method:"POST",cache:"no-store",mode:"cors",credentials:"include",headers:{Authorization:"Bearer "+s.siteKey,"X-File":t}}).then(function(){delete s.fileCache[t],s.fileList.splice(s.fileList.indexOf(t),1),h(),g(),I("data-deleted")}).catch(function(e){c(e)})}function C(){I("data-saved")}function I(e){r();var t=document.querySelector(".msg.file-event");t.textContent=t.getAttribute(e),t.style.display="",window.setTimeout(function(){t.style.display="none",t.textContent=""},1e3)}function A(){var e=s.urlRoot+"delete-site",t=document.querySelector(".btn.delete-site").getAttribute("data-prompt");confirm(t)&&a(e,{method:"POST",cache:"no-store",mode:"cors",credentials:"include",headers:{Authorization:"Bearer "+s.siteKey}}).then(function(){document.querySelector(".site-expired").style.display="none",o()}).catch(function(e){c("The following server error occurred while deleting your site. ["+e.toString()+"]. All files should be deleted within an hour."),o()})}function E(e){var t=null;switch(e.type){case"htm":t="text/x-handlebars-template";break;case"js":t="text/javascript";break;case"jsx":t="text/jsx";break;case"css":t="text/css";break;case"svg":t="application/xml";break;case"graphql":t="text/plain";break;default:return void c("Unknown file type, new file type not yet handled.")}if(null!==s.cm){try{s.cm.toTextArea()}catch(e){console.warn("Error calling: state.cm.toTextArea()"),console.info(e)}s.cm=null}document.getElementById("code-editor").value=e.content,w(t),v(e.file),document.getElementById("file-list").value=e.file}if(document.querySelector("url-router"))return window.setupPlayground=function(){e(),document.querySelector("footer").style.display="none",document.addEventListener("app:i18nLoaded",n)},window.unloadPlayground=function(){null!==s.countdownInterval&&(window.clearInterval(s.countdownInterval),s.countdownInterval=null),document.querySelector("footer").style.display="",document.onkeydown=null,document.removeEventListener("app:i18nLoaded",n)};app.addPage("playground",{model:{getState:function(){return s}},onRendered:function(){e(),document.querySelector("footer").style.display="none"},onRouteUnload:function(){null!==s.countdownInterval&&(window.clearInterval(s.countdownInterval),s.countdownInterval=null),document.querySelector("footer").style.display="",document.onkeydown=null}})}();