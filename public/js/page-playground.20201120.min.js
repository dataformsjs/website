!function(){"use strict";var e={cm:null,lang:navigator.language,urlRoot:"https://playground.dataformsjs.com/",selectedFile:null,fileList:[],fileCache:{},siteKey:null,siteString:null,siteExpires:null,contentChanged:!1,countdownInterval:null};function t(){e.lang=window.i18n_Locale,e.siteKey=localStorage.getItem("playground_site"),f(),e.siteKey?0===e.fileList.length||null===e.selectedFile?o("download-site"):(v(),L(e.fileCache[e.selectedFile]),u()):o("site-template"),function(){var t=document.querySelectorAll(".btn.create-site");if(0===t.length)return;t[0].onclick=s,t[1].onclick=s,document.querySelector(".btn.save-file").onclick=b,document.querySelector(".btn.rename-file").onclick=q,document.querySelector(".btn.add-file").onclick=g,document.querySelector(".btn.delete-file").onclick=C,document.querySelector(".btn.delete-site").onclick=E,document.getElementById("file-list").onchange=function(){x(this.value)},document.querySelector(".error .close-error").onclick=function(){document.querySelector(".content.error-message").style.display="none"},r();var n=document.getElementById("file-type");n.onchange=function(){e.cm.toTextArea(),e.cm=null;var t=n.options[n.selectedIndex].getAttribute("data-mode");w(t),c()};var l=document.getElementById("file-name");l.oninput=c,l.onpaste=function(e){var t=e.clipboardData.getData("text/plain");/^[A-Za-z0-9_-]{1,}$/.test(t)||e.preventDefault()},l.onkeydown=function(e){var t=e.keyCode;switch(e.keyCode){case 8:case 37:case 38:case 39:case 40:case 46:case 189:return}if(!(t>=65&&t<=90)&&!(t>=97&&t<=122)&&(!(t>=48&&t<=57)||e.shiftKey))return!1}}(),document.onkeydown=function(t){if(e.siteKey&&(t.ctrlKey||t.metaKey)&&83===t.keyCode)return b(),!1}}function n(){null!==e.countdownInterval&&(window.clearInterval(e.countdownInterval),e.countdownInterval=null),e.selectedFile=null,e.fileList=[],e.fileCache={},e.siteKey=null,e.siteString=null,e.siteExpires=null,e.contentChanged=!1,localStorage.removeItem("playground_site"),e.cm.toTextArea(),e.cm=null,document.getElementById("code-editor").value="",document.getElementById("countdown").className="",document.querySelector(".editor-container").classList.remove("warning"),o("site-template"),function(){document.querySelector(".create-site-overlay").style.display="",document.querySelector(".create-another-site-screen").style.display="";var e=document.querySelectorAll(".controls");Array.prototype.forEach.call(e,function(e){e.style.display="none"}),document.querySelector(".editor-container").classList.add("no-site"),document.querySelector(".btn.view-site").href="#",document.querySelector(".btn.view-file").href="#"}()}function l(e,t){return fetch(e,t).then(function(e){return e.json()}).then(function(e){if(e.error)throw e.error;return e})}function o(t){var n={method:"POST",cache:"no-store",mode:"cors",credentials:"include"};"download-site"===t?n.headers={Authorization:"Bearer "+e.siteKey}:t=e.lang+"/"+t,l(e.urlRoot+t,n).then(function(t){!function(t){e.fileList=t.files,v(),document.getElementById("code-editor").value=t.app_code,e.fileCache["app.htm"]={type:"htm",file:"app.htm",content:t.app_code}}(t),w(),S("app.htm"),e.siteKey&&u()}).catch(function(n){if("download-site"!==t){var l=document.querySelector(".error-messages");if(!l)return;var o=l.getAttribute("data-server-down");i(o+=" Error: "+n.toString())}else i(n);"download-site"===t&&window.setTimeout(function(){var t=document.querySelector(".error-messages");if(t){var n=t.getAttribute("data-saved-site");confirm(n)&&(localStorage.removeItem("playground_site"),e.siteKey=null,e.siteString=null,e.siteExpires=null,window.location.reload(!0))}},100)})}function r(){var e=document.querySelector(".mobile-message p");if(e){var t=window.navigator.userAgent.toLowerCase(),n=t.indexOf("android")>-1||t.indexOf("iphone")>-1||t.indexOf("ipad")>-1?"data-mobile-screen":"data-narrow-screen";e.textContent=e.getAttribute(n)}}function i(e){var t=document.querySelector(".error-message");if(t){var n=t.querySelector("p .text"),l=e;-1===l.toString().toLowerCase().indexOf("error")&&(l="Error: "+l),n.textContent=l,t.style.display="",console.error(e)}}function a(){document.querySelector(".btn.save-file").style.display="none",document.querySelector(".btn.rename-file").style.display="none",document.querySelector(".msg.file-already-exists").style.display="none"}function c(){var t,n=document.querySelector(".btn.save-file"),l=document.querySelector(".btn.rename-file"),o=document.querySelector(".msg.file-already-exists"),r=document.getElementById("file-name").value,i=""!==r,a=null===e.selectedFile,c=e.selectedFile;a||(c=c.substring(0,c.indexOf(".")));var s="app.htm"!==e.selectedFile&&!a&&c!==r,u=!1,y=!1;if(a||s){var m=r+"."+(a?document.getElementById("file-type").value:e.fileCache[e.selectedFile].type);"app.htm"===m.toLowerCase()||"index.htm"===m.toLowerCase()?y=!0:u=d(m)}o.style.display="none",i?u||y?(t=u?"data-already-exists":"data-name-not-allowed",o.textContent=o.getAttribute(t),o.style.display="",n.style.display="none",l.style.display="none"):s?(p()||(n.querySelector(".text").textContent=n.getAttribute("data-save-as"),n.style.display=""),t=e.contentChanged?"data-rename-and-save":"data-rename",l.querySelector(".text").textContent=l.getAttribute(t),l.style.display=""):e.contentChanged?(n.querySelector(".text").textContent=n.getAttribute("data-save"),n.style.display="",l.style.display="none"):(n.style.display="none",l.style.display="none"):(n.style.display="none",l.style.display="none")}function d(t){t=t.toLowerCase();for(var n=0,l=e.fileList.length;n<l;n++)if(e.fileList[n].toLowerCase()===t)return!0;return"index.htm"===t}function s(){l(e.urlRoot+e.lang+"/create-site",{method:"POST",cache:"no-store"}).then(function(t){var n;n=t.site,e.siteKey=n,localStorage.setItem("playground_site",n),f(),u()}).catch(function(e){i(e)})}function u(){document.querySelector(".create-site-overlay").style.display="none",document.querySelector(".create-site-screen").style.display="none",document.querySelector(".create-another-site-screen").style.display="none";var t=document.querySelectorAll(".controls");Array.prototype.forEach.call(t,function(e){e.style.display=""}),document.querySelector(".editor-container").classList.remove("no-site");var n=e.urlRoot+"sites/"+e.siteString+"/app.htm";document.querySelector(".btn.view-site").href=n,document.querySelector(".btn.view-file").href=n,y()}function y(){var t=new Date,l=Math.floor((e.siteExpires-t.getTime())/1e3),o=document.getElementById("countdown"),r=0,i=0;null!==e.countdownInterval&&(window.clearInterval(e.countdownInterval),e.countdownInterval=null),l>60?(r=Math.ceil(l/60),0===(i=l%60)&&(i=60),o.textContent=o.getAttribute("data-minutes").replace("{time}",r),e.countdownInterval=window.setTimeout(y,1e3*i)):(m(o,l),l--,e.countdownInterval=window.setInterval(function(){m(o,l),--l<0&&(document.querySelector(".site-expired").style.display="",n())},1e3)),l<=600&&o.classList.add("warning")}function m(e,t){e.textContent=1===t?e.getAttribute("data-one-second"):e.getAttribute("data-seconds").replace("{time}",t),e.classList.toggle("scale"),document.querySelector(".editor-container").classList.toggle("warning")}function f(){if(e.siteKey){var t=e.siteKey.match(/^([a-zA-Z0-9_-]{2,}).s.(\d+).[a-zA-Z0-9_-]{2,}$/);if(!t)return void(e.siteKey=null);e.siteString=function(e){var t=e.length%4;0!==t&&(t=4-t);var n=e.replace(/_/g,"/").replace(/-/g,"+")+"=".repeat(t);return atob(n)}(t[1]),e.siteExpires=parseInt(t[2],10),Date.now()>new Date(e.siteExpires)&&(e.siteKey=null,e.siteString=null,e.siteExpires=null)}}function p(){return e.fileList.length>=30}function v(){e.fileList.sort(function(e,t){return"app.htm"===e?-1:"app.htm"===t?1:e.localeCompare(t)});for(var t="",n="",l=0,o=e.fileList.length;l<o;l++){var r=e.fileList[l],i=r.indexOf(".");t+='<li class="'+r.substring(i+1)+'">'+(r=h(r))+"</li>",n+="<option>"+r+"</option>"}document.querySelector(".files ul").innerHTML=t,document.getElementById("file-list").innerHTML=n;var a=document.querySelector(".btn.add-file"),c=document.querySelector(".msg.file-limit");p()?(c.style.display="",a.style.display="none"):(c.style.display="none",a.style.display="");var d=document.querySelectorAll(".files li");Array.prototype.forEach.call(d,function(e){e.onclick=function(){x(this.textContent)}})}function h(e){return void 0===e||null===e||"number"==typeof e?e:String(e).replace(/&/g,"&amp;").replace(/"/g,"&quot;").replace(/'/g,"&#039;").replace(/</g,"&lt;").replace(/>/g,"&gt;")}function g(){var t=document.querySelectorAll(".files li");Array.prototype.forEach.call(t,function(e){e.classList.remove("active")}),e.selectedFile=null,e.contentChanged=!0;var n=document.getElementById("file-type");document.getElementById("file-name").value="",document.getElementById("file-name").disabled=!1,n.style.display="",document.querySelector(".btn.view-file").style.display="none",document.querySelector(".btn.delete-file").style.display="none",a();var l=document.getElementById("file-name");l.value="",l.style.display="",e.cm.toTextArea(),e.cm=null,document.getElementById("code-editor").value="",w(n.options[n.selectedIndex].getAttribute("data-mode"))}function S(t){var n=document.querySelectorAll(".files li");Array.prototype.forEach.call(n,function(e){e.textContent===t?e.classList.add("active"):e.classList.remove("active")}),e.selectedFile=t,e.contentChanged=!1;var l=document.querySelector(".btn.view-file");l.style.display="none",e.siteString&&"app.htm"!==t&&(l.href=e.urlRoot+"sites/"+e.siteString+"/",l.href+=t,l.style.display="");var o=document.getElementById("file-name"),r=document.querySelector(".btn.delete-file");if("app.htm"===t)o.disabled=!0,o.value=t,r.style.display="none";else{var i=t.indexOf("."),d=t.substring(0,i);o.disabled=!1,o.value=d,o.style.display="",r.style.display=""}document.getElementById("file-type").style.display="none",a(),e.cm.on("change",function(){e.cm.save();var n=void 0===e.fileCache[t]?"":e.fileCache[t].content,l=document.getElementById("code-editor").value;n=n.replace(/\r\n/g,"\n"),l=l.replace(/\r\n/g,"\n"),e.contentChanged=l!==n,c()})}function w(t){void 0===t&&(t="text/x-handlebars-template");var n={lineNumbers:!0,matchBrackets:!0,mode:t,indentUnit:4,indentWithTabs:!1};if("text/javascript"===t?(n.gutters=["CodeMirror-lint-markers"],n.lint=!0):"text/x-handlebars-template"===t&&(n.mode={name:"handlebars",base:"htmlmixed"}),null!==e.cm){var l=document.querySelectorAll(".CodeMirror.cm-s-default");l&&Array.prototype.forEach.call(l,function(e){e.parentNode.removeChild(e)})}e.cm=CodeMirror.fromTextArea(document.getElementById("code-editor"),n)}function x(t){void 0!==e.fileCache[t]?L(e.fileCache[t]):function(t){l(e.urlRoot+"get-file",{method:"POST",cache:"no-store",mode:"cors",credentials:"include",headers:{Authorization:"Bearer "+e.siteKey,"X-File":t}}).then(function(n){e.fileCache[t]=n,L(n)}).catch(function(e){i(e)})}(t)}function b(){e.cm.save();var t=document.getElementById("code-editor").value,n=null,o=null,r=document.getElementById("file-name").value,a=!1,c=!1;if(null===e.selectedFile){if(o=r,n=document.getElementById("file-type").value,a=!0,""===o||""===n)return;o+="."+n}else if("app.htm"===e.selectedFile)o=e.selectedFile;else{var s=e.selectedFile;s=s.substring(0,s.indexOf(".")),(c=s!==r)?(n=e.fileCache[e.selectedFile].type,o=r+"."+n):o=e.selectedFile}(a||c)&&d(o)||(c&&p()||l(e.urlRoot+"save-file",{method:"POST",cache:"no-store",mode:"cors",credentials:"include",headers:{Authorization:"Bearer "+e.siteKey,"X-File":o,"Content-Type":"text/plain"},body:t}).then(function(){a||c?(e.fileCache[o]={type:n,file:o,content:t},e.fileList.push(o),v(),S(o)):(e.fileCache[o].content=t,e.contentChanged=!1),I()}).catch(function(e){i(e)}))}function q(){e.cm.save();var t=document.getElementById("code-editor").value,n=e.selectedFile,o=e.fileCache[n].type,r=document.getElementById("file-name").value+"."+o;l(e.urlRoot+"rename-file",{method:"POST",cache:"no-store",mode:"cors",credentials:"include",headers:{Authorization:"Bearer "+e.siteKey,"X-File":n,"X-Rename":r,"Content-Type":"text/plain"},body:t}).then(function(){delete e.fileCache[n],e.fileList.splice(e.fileList.indexOf(n),1),e.fileCache[r]={type:o,file:r,content:t},e.fileList.push(r),v(),S(r),I()}).catch(function(e){i(e)})}function C(){var t=e.urlRoot+"delete-file",n=e.selectedFile;l(t,{method:"POST",cache:"no-store",mode:"cors",credentials:"include",headers:{Authorization:"Bearer "+e.siteKey,"X-File":n}}).then(function(){delete e.fileCache[n],e.fileList.splice(e.fileList.indexOf(n),1),v(),g(),A("data-deleted")}).catch(function(e){i(e)})}function I(){A("data-saved")}function A(e){a();var t=document.querySelector(".msg.file-event");t.textContent=t.getAttribute(e),t.style.display="",window.setTimeout(function(){t.style.display="none",t.textContent=""},1e3)}function E(){var t=e.urlRoot+"delete-site",o=document.querySelector(".btn.delete-site").getAttribute("data-prompt");confirm(o)&&l(t,{method:"POST",cache:"no-store",mode:"cors",credentials:"include",headers:{Authorization:"Bearer "+e.siteKey}}).then(function(){document.querySelector(".site-expired").style.display="none",n()}).catch(function(e){i("The following server error occurred while deleting your site. ["+e.toString()+"]. All files should be deleted within an hour."),n()})}function L(t){var n=null;switch(t.type){case"htm":n="text/x-handlebars-template";break;case"js":n="text/javascript";break;case"jsx":n="text/jsx";break;case"css":n="text/css";break;case"svg":n="application/xml";break;case"graphql":n="text/plain";break;default:return void i("Unknown file type, new file type not yet handled.")}null!==e.cm&&(e.cm.toTextArea(),e.cm=null),document.getElementById("code-editor").value=t.content,w(n),S(t.file),document.getElementById("file-list").value=t.file}if(document.querySelector("url-router"))return window.setupPlayground=function(){t(),document.querySelector("footer").style.display="none",document.addEventListener("app:i18nLoaded",r)},void(window.unloadPlayground=function(){null!==e.countdownInterval&&(window.clearInterval(e.countdownInterval),e.countdownInterval=null),document.querySelector("footer").style.display="",document.onkeydown=null,document.removeEventListener("app:i18nLoaded",r)});app.addPage("playground",{model:{getState:function(){return e}},onRendered:function(){t(),document.querySelector("footer").style.display="none"},onRouteUnload:function(){null!==e.countdownInterval&&(window.clearInterval(e.countdownInterval),e.countdownInterval=null),document.querySelector("footer").style.display="",document.onkeydown=null}})}();