!function(){"use strict";var s={cm:null,lang:navigator.language,urlRoot:"https://playground.dataformsjs.com/",selectedFile:null,fileList:[],fileCache:{},siteKey:null,siteString:null,siteExpires:null,contentChanged:!1,countdownInterval:null};function e(){var e,t;s.lang=window.i18n_Locale,s.siteKey=localStorage.getItem("playground_site"),v(),s.siteKey?0===s.fileList.length||null===s.selectedFile?n("download-site"):(d(),L(s.fileCache[s.selectedFile]),p()):n("site-template"),0!==(t=document.querySelectorAll(".btn.create-site")).length&&(t[0].onclick=f,t[1].onclick=f,document.querySelector(".btn.save-file").onclick=b,document.querySelector(".btn.rename-file").onclick=q,document.querySelector(".btn.add-file").onclick=S,document.querySelector(".btn.delete-file").onclick=C,document.querySelector(".btn.delete-site").onclick=E,document.getElementById("file-list").onchange=function(){x(this.value)},document.querySelector(".error .close-error").onclick=function(){document.querySelector(".content.error-message").style.display="none"},y(),(e=document.getElementById("file-type")).onchange=function(){s.cm.toTextArea(),s.cm=null,l(e.options[e.selectedIndex].getAttribute("data-mode")),r()},(t=document.getElementById("file-name")).oninput=r,t.onpaste=function(e){var t=e.clipboardData.getData("text/plain");/^[A-Za-z0-9_-]{1,}$/.test(t)||e.preventDefault()},t.onkeydown=function(e){var t=e.keyCode;switch(e.keyCode){case 8:case 37:case 38:case 39:case 40:case 46:case 189:return}if(!(65<=t&&t<=90)&&!(97<=t&&t<=122)&&(!(48<=t&&t<=57)||e.shiftKey))return!1}),document.onkeydown=function(e){if(s.siteKey&&(e.ctrlKey||e.metaKey)&&83===e.keyCode)return b(),!1}}function o(){var e;null!==s.countdownInterval&&(window.clearInterval(s.countdownInterval),s.countdownInterval=null),s.selectedFile=null,s.fileList=[],s.fileCache={},s.siteKey=null,s.siteString=null,s.siteExpires=null,s.contentChanged=!1,localStorage.removeItem("playground_site"),s.cm.toTextArea(),s.cm=null,document.getElementById("code-editor").value="",document.getElementById("countdown").className="",document.querySelector(".editor-container").classList.remove("warning"),n("site-template"),document.querySelector(".create-site-overlay").style.display="",document.querySelector(".create-another-site-screen").style.display="",e=document.querySelectorAll(".controls"),Array.prototype.forEach.call(e,function(e){e.style.display="none"}),document.querySelector(".editor-container").classList.add("no-site"),document.querySelector(".btn.view-site").href="#",document.querySelector(".btn.view-file").href="#"}function a(e,t){return fetch(e,t).then(function(e){return e.json()}).then(function(e){if(e.error)throw e.error;return e})}function n(n){var e={method:"POST",cache:"no-store",mode:"cors",credentials:"include"};"download-site"===n?e.headers={Authorization:"Bearer "+s.siteKey}:n=s.lang+"/"+n,a(s.urlRoot+n,e).then(function(e){e=e,s.fileList=e.files,d(),document.getElementById("code-editor").value=e.app_code,s.fileCache["app.htm"]={type:"htm",file:"app.htm",content:e.app_code},l(),u("app.htm"),s.siteKey&&p()}).catch(function(e){if("download-site"!==n){var t=document.querySelector(".error-messages");if(!t)return;t=t.getAttribute("data-server-down");c(t+=" Error: "+e.toString())}else c(e);"download-site"===n&&window.setTimeout(function(){var e=document.querySelector(".error-messages");e&&(e=e.getAttribute("data-saved-site"),confirm(e)&&(localStorage.removeItem("playground_site"),s.siteKey=null,s.siteString=null,s.siteExpires=null,window.location.reload(!0)))},100)})}function t(){y(),s.siteKey&&h()}function y(){var e,t=document.querySelector(".mobile-message p");t&&(e=-1<(e=window.navigator.userAgent.toLowerCase()).indexOf("android")||-1<e.indexOf("iphone")||-1<e.indexOf("ipad"),t.textContent=t.getAttribute(e?"data-mobile-screen":"data-narrow-screen"))}function c(e){var t,n,l=document.querySelector(".error-message");l&&(t=l.querySelector("p .text"),-1===(n=e).toString().toLowerCase().indexOf("error")&&(n="Error: "+n),t.textContent=n,l.style.display="",console.error(e))}function i(){document.querySelector(".btn.save-file").style.display="none",document.querySelector(".btn.rename-file").style.display="none",document.querySelector(".msg.file-already-exists").style.display="none"}function r(){var e,t=document.querySelector(".btn.save-file"),n=document.querySelector(".btn.rename-file"),l=document.querySelector(".msg.file-already-exists"),o=document.getElementById("file-name").value,i=""!==o,r=null===s.selectedFile,a=s.selectedFile,a=(r||(a=a.substring(0,a.indexOf("."))),"app.htm"!==s.selectedFile&&!r&&a!==o),c=!1,d=!1;(r||a)&&("app.htm"===(o=o+"."+(r?document.getElementById("file-type").value:s.fileCache[s.selectedFile].type)).toLowerCase()||"index.htm"===o.toLowerCase()?d=!0:c=m(o)),l.style.display="none",i?c||d?(l.textContent=l.getAttribute(e=c?"data-already-exists":"data-name-not-allowed"),l.style.display="",t.style.display="none",n.style.display="none"):a?(w()||(t.querySelector(".text").textContent=t.getAttribute("data-save-as"),t.style.display=""),e=s.contentChanged?"data-rename-and-save":"data-rename",n.querySelector(".text").textContent=n.getAttribute(e),n.style.display=""):(s.contentChanged?(t.querySelector(".text").textContent=t.getAttribute("data-save"),t.style.display=""):t.style.display="none",n.style.display="none"):(t.style.display="none",n.style.display="none")}function m(e){e=e.toLowerCase();for(var t=0,n=s.fileList.length;t<n;t++)if(s.fileList[t].toLowerCase()===e)return!0;return"index.htm"===e}function f(){a(s.urlRoot+s.lang+"/create-site",{method:"POST",cache:"no-store"}).then(function(e){e=e.site,s.siteKey=e,localStorage.setItem("playground_site",e),v(),p()}).catch(function(e){c(e)})}function p(){document.querySelector(".create-site-overlay").style.display="none",document.querySelector(".create-site-screen").style.display="none",document.querySelector(".create-another-site-screen").style.display="none";var e=document.querySelectorAll(".controls"),e=(Array.prototype.forEach.call(e,function(e){e.style.display=""}),document.querySelector(".editor-container").classList.remove("no-site"),s.urlRoot+"sites/"+s.siteString+"/app.htm");document.querySelector(".btn.view-site").href=e,document.querySelector(".btn.view-file").href=e,h()}function h(){var e,t=new Date,n=Math.floor((s.siteExpires-t.getTime())/1e3),l=document.getElementById("countdown"),t=0;null!==s.countdownInterval&&(window.clearInterval(s.countdownInterval),s.countdownInterval=null),60<n?(e=Math.ceil(n/60),0===(t=n%60)&&(t=60),l.textContent=l.getAttribute("data-minutes").replace("{time}",e),s.countdownInterval=window.setTimeout(h,1e3*t)):(g(l,n),n--,s.countdownInterval=window.setInterval(function(){g(l,n),--n<0&&(document.querySelector(".site-expired").style.display="",o())},1e3)),n<=600&&l.classList.add("warning")}function g(e,t){e.textContent=1===t?e.getAttribute("data-one-second"):e.getAttribute("data-seconds").replace("{time}",t),e.classList.toggle("scale"),document.querySelector(".editor-container").classList.toggle("warning")}function v(){var e;s.siteKey&&((e=s.siteKey.match(/^([a-zA-Z0-9_-]{2,}).s.(\d+).[a-zA-Z0-9_-]{2,}$/))?(s.siteString=function(e){var t=e.length%4;0!==t&&(t=4-t);e=e.replace(/_/g,"/").replace(/-/g,"+")+"=".repeat(t);return atob(e)}(e[1]),s.siteExpires=parseInt(e[2],10),Date.now()>new Date(s.siteExpires)&&(s.siteKey=null,s.siteString=null,s.siteExpires=null)):s.siteKey=null)}function w(){return 30<=s.fileList.length}function d(){s.fileList.sort(function(e,t){return"app.htm"===e?-1:"app.htm"===t?1:e.localeCompare(t)});for(var e="",t="",n=0,l=s.fileList.length;n<l;n++){var o=s.fileList[n],i=o.indexOf(".");e+='<li class="'+o.substring(i+1)+'">'+(o=null!=(i=o)&&"number"!=typeof i?String(i).replace(/&/g,"&amp;").replace(/"/g,"&quot;").replace(/'/g,"&#039;").replace(/</g,"&lt;").replace(/>/g,"&gt;"):i)+"</li>",t+="<option>"+o+"</option>"}document.querySelector(".files ul").innerHTML=e,document.getElementById("file-list").innerHTML=t;var r=document.querySelector(".btn.add-file"),a=document.querySelector(".msg.file-limit"),a=(w()?(a.style.display="",r.style.display="none"):(a.style.display="none",r.style.display=""),document.querySelectorAll(".files li"));Array.prototype.forEach.call(a,function(e){e.onclick=function(){x(this.textContent)}})}function S(){var e=document.querySelectorAll(".files li"),e=(Array.prototype.forEach.call(e,function(e){e.classList.remove("active")}),s.selectedFile=null,s.contentChanged=!0,document.getElementById("file-type")),t=(document.getElementById("file-name").value="",document.getElementById("file-name").disabled=!1,e.style.display="",document.querySelector(".btn.view-file").style.display="none",document.querySelector(".btn.delete-file").style.display="none",i(),document.getElementById("file-name"));t.value="",t.style.display="",s.cm.toTextArea(),s.cm=null,document.getElementById("code-editor").value="",l(e.options[e.selectedIndex].getAttribute("data-mode"))}function u(n){var e,t=document.querySelectorAll(".files li"),t=(Array.prototype.forEach.call(t,function(e){e.textContent===n?e.classList.add("active"):e.classList.remove("active")}),s.selectedFile=n,s.contentChanged=!1,document.querySelector(".btn.view-file")),t=(t.style.display="none",s.siteString&&"app.htm"!==n&&(t.href=s.urlRoot+"sites/"+s.siteString+"/",t.href+=n,t.style.display=""),document.getElementById("file-name")),l=document.querySelector(".btn.delete-file");"app.htm"===n?(t.disabled=!0,t.value=n,l.style.display="none"):(e=n.indexOf("."),e=n.substring(0,e),t.disabled=!1,t.value=e,t.style.display="",l.style.display=""),document.getElementById("file-type").style.display="none",i(),s.cm.on("change",function(){s.cm.save();var e=void 0===s.fileCache[n]?"":s.fileCache[n].content,t=document.getElementById("code-editor").value,e=e.replace(/\r\n/g,"\n"),t=t.replace(/\r\n/g,"\n");s.contentChanged=t!==e,r()})}function l(e){var t={lineNumbers:!0,matchBrackets:!0,mode:e=void 0===e?"text/x-handlebars-template":e,indentUnit:4,indentWithTabs:!1};"text/javascript"===e?(t.gutters=["CodeMirror-lint-markers"],t.lint=!0):"text/x-handlebars-template"===e&&(t.mode={name:"handlebars",base:"htmlmixed"}),null===s.cm||(e=document.querySelectorAll(".CodeMirror.cm-s-default"))&&Array.prototype.forEach.call(e,function(e){e.parentNode.removeChild(e)}),s.cm=CodeMirror.fromTextArea(document.getElementById("code-editor"),t)}function x(e){var t;void 0!==s.fileCache[e]?L(s.fileCache[e]):(t=e,a(s.urlRoot+"get-file",{method:"POST",cache:"no-store",mode:"cors",credentials:"include",headers:{Authorization:"Bearer "+s.siteKey,"X-File":t}}).then(function(e){L(s.fileCache[t]=e)}).catch(function(e){c(e)}))}function b(){s.cm.save();var e,t=document.getElementById("code-editor").value,n=null,l=null,o=document.getElementById("file-name").value,i=!1,r=!1;if(null===s.selectedFile){if(l=o,n=document.getElementById("file-type").value,i=!0,""===l||""===n)return;l+="."+n}else l="app.htm"===s.selectedFile?s.selectedFile:(e=(e=s.selectedFile).substring(0,e.indexOf(".")),(r=e!==o)?o+"."+(n=s.fileCache[s.selectedFile].type):s.selectedFile);(i||r)&&m(l)||r&&w()||a(s.urlRoot+"save-file",{method:"POST",cache:"no-store",mode:"cors",credentials:"include",headers:{Authorization:"Bearer "+s.siteKey,"X-File":l,"Content-Type":"text/plain"},body:t}).then(function(){i||r?(s.fileCache[l]={type:n,file:l,content:t},s.fileList.push(l),d(),u(l)):(s.fileCache[l].content=t,s.contentChanged=!1),I()}).catch(function(e){c(e)})}function q(){s.cm.save();var e=document.getElementById("code-editor").value,t=s.selectedFile,n=s.fileCache[t].type,l=document.getElementById("file-name").value+"."+n;a(s.urlRoot+"rename-file",{method:"POST",cache:"no-store",mode:"cors",credentials:"include",headers:{Authorization:"Bearer "+s.siteKey,"X-File":t,"X-Rename":l,"Content-Type":"text/plain"},body:e}).then(function(){delete s.fileCache[t],s.fileList.splice(s.fileList.indexOf(t),1),s.fileCache[l]={type:n,file:l,content:e},s.fileList.push(l),d(),u(l),I()}).catch(function(e){c(e)})}function C(){var e=s.urlRoot+"delete-file",t=s.selectedFile;a(e,{method:"POST",cache:"no-store",mode:"cors",credentials:"include",headers:{Authorization:"Bearer "+s.siteKey,"X-File":t}}).then(function(){delete s.fileCache[t],s.fileList.splice(s.fileList.indexOf(t),1),d(),S(),A("data-deleted")}).catch(function(e){c(e)})}function I(){A("data-saved")}function A(e){i();var t=document.querySelector(".msg.file-event");t.textContent=t.getAttribute(e),t.style.display="",window.setTimeout(function(){t.style.display="none",t.textContent=""},1e3)}function E(){var e=s.urlRoot+"delete-site",t=document.querySelector(".btn.delete-site").getAttribute("data-prompt");confirm(t)&&a(e,{method:"POST",cache:"no-store",mode:"cors",credentials:"include",headers:{Authorization:"Bearer "+s.siteKey}}).then(function(){document.querySelector(".site-expired").style.display="none",o()}).catch(function(e){c("The following server error occurred while deleting your site. ["+e.toString()+"]. All files should be deleted within an hour."),o()})}function L(e){var t=null;switch(e.type){case"htm":t="text/x-handlebars-template";break;case"js":t="text/javascript";break;case"jsx":t="text/jsx";break;case"css":t="text/css";break;case"svg":t="application/xml";break;case"graphql":case"txt":t="text/plain";break;default:return void c("Unknown file type, new file type not yet handled.")}if(null!==s.cm){try{s.cm.toTextArea()}catch(e){console.warn("Error calling: state.cm.toTextArea()"),console.warn(e)}s.cm=null}document.getElementById("code-editor").value=e.content,l(t),u(e.file),document.getElementById("file-list").value=e.file}if(document.querySelector("url-router"))return window.setupPlayground=function(){e(),document.querySelector("footer").style.display="none",document.addEventListener("app:i18nLoaded",t)},window.unloadPlayground=function(){null!==s.countdownInterval&&(window.clearInterval(s.countdownInterval),s.countdownInterval=null),document.querySelector("footer").style.display="",document.onkeydown=null,document.removeEventListener("app:i18nLoaded",t)};app.addPage("playground",{model:{getState:function(){return s}},onRendered:function(){e(),document.querySelector("footer").style.display="none"},onRouteUnload:function(){null!==s.countdownInterval&&(window.clearInterval(s.countdownInterval),s.countdownInterval=null),document.querySelector("footer").style.display="",document.onkeydown=null}})}();